# Step 0: Initial Setup & Configuration

## Objective
Set up the Convex backend infrastructure and configure the development environment for the Visionairy app.

## Prerequisites
- Node.js 18+ installed
- npm or bun package manager
- Access to OpenAI API key
- Existing React/Vite frontend application

## Deliverables
- ✅ Convex packages installed and configured
- ✅ Environment variables set up
- ✅ Basic Convex project structure created
- ✅ Development server running successfully

## Implementation Steps

### 1. Install Dependencies

```bash
# Install core Convex packages
npm install convex @convex-dev/auth

# Install additional dependencies  
npm install --save-dev @types/node

# Install OpenAI SDK for later use
npm install openai
```

### 2. Initialize Convex Project

```bash
# This command will:
# - Create convex/ directory
# - Generate TypeScript types
# - Set up development deployment
npx convex dev

# Keep this running in a terminal during development
```

### 3. Configure Environment Variables

```bash
# Set the site URL for authentication redirects
npx convex env set SITE_URL http://localhost:5173

# Set OpenAI API key for image generation
npx convex env set OPENAI_API_KEY your_openai_api_key_here

# Optional: Generate and set JWT private key for enhanced security
npx convex env set JWT_PRIVATE_KEY "$(openssl ecparam -name secp256k1 -genkey -noout | openssl ec -outform DER | tail -c +8 | head -c 32 | xxd -p -c 32)"
```

### 4. Update Vite Configuration

Update `vite.config.ts`:

```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react-swc'

export default defineConfig({
  plugins: [react()],
  define: {
    'process.env': process.env
  }
})
```

### 5. Create Base Directory Structure

Create the following structure in your project:

```
convex/
  ├── _generated/       # Auto-generated by Convex (DO NOT EDIT)
  ├── schema.ts        # Will contain database schema
  ├── auth.ts          # Will contain auth configuration  
  ├── http.ts          # Will contain HTTP routes
  └── lib/             # Shared utilities
      └── constants.ts # Game constants
```

### 6. Create Initial Constants File

Create `convex/lib/constants.ts`:

```typescript
// Game configuration constants
export const GAME_CONFIG = {
  DEFAULT_MAX_PLAYERS: 8,
  DEFAULT_ROUNDS_PER_GAME: 5,
  DEFAULT_TIME_PER_ROUND: 90, // seconds
  PROMPT_PHASE_DURATION: 60000, // 60 seconds
  GENERATION_PHASE_DURATION: 30000, // 30 seconds  
  VOTING_PHASE_DURATION: 45000, // 45 seconds
  RESULTS_PHASE_DURATION: 15000, // 15 seconds
  POINTS_PER_WIN: 100,
  POINTS_PER_VOTE: 10,
} as const;

// Room code configuration
export const ROOM_CODE_LENGTH = 6;
export const ROOM_CODE_CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
```

### 7. Update Frontend Entry Point

Update `src/main.tsx` to prepare for Convex integration:

```tsx
import React from "react";
import ReactDOM from "react-dom/client";
import { ConvexReactClient } from "convex/react";
import App from "./App.tsx";
import "./index.css";

// Initialize Convex client
const convex = new ConvexReactClient(import.meta.env.VITE_CONVEX_URL as string);

// Note: We'll add ConvexAuthProvider in the next step
ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
);
```

### 8. Add Environment Type Definitions

Create `src/vite-env.d.ts` if not exists:

```typescript
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_CONVEX_URL: string
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
```

## Verification Steps

1. **Check Convex is running:**
   - Terminal should show "Convex functions ready" message
   - No TypeScript errors in convex/ directory

2. **Verify environment variables:**
   ```bash
   npx convex env list
   ```
   Should show SITE_URL and OPENAI_API_KEY

3. **Test deployment connection:**
   - Open browser to the URL shown in terminal
   - Should see Convex dashboard

4. **Verify file structure:**
   - convex/_generated/ folder exists
   - convex/_generated/api.ts file is created
   - convex/_generated/server.ts file is created

## Available Debug Tools

You have access to Convex MCP tools for debugging:

```bash
# Check deployment status
mcp_convex_status --projectDir .

# List environment variables
mcp_convex_envList --deploymentSelector dev

# View deployment URL and dashboard
mcp_convex_status --projectDir . | grep "URL"
```

## Common Issues & Solutions

### Issue: "CONVEX_URL not set"
**Solution:** Make sure `npx convex dev` is running and check the .env.local file exists

### Issue: TypeScript errors in import statements  
**Solution:** Wait for Convex to generate types, restart `npx convex dev`

### Issue: "Cannot find module 'convex/react'"
**Solution:** Ensure convex package is installed: `npm install convex`

## Next Steps
Once setup is complete and verified:
1. Keep `npx convex dev` running in a terminal
2. Proceed to **01-authentication-instructions.md**
3. Do not modify files in convex/_generated/

## Success Criteria
- [ ] All packages installed without errors
- [ ] Convex dev server running
- [ ] Environment variables configured
- [ ] File structure created
- [ ] No TypeScript errors
- [ ] Can access Convex dashboard
